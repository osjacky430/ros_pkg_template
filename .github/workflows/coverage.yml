name: coverage

on: [push, pull_request]

jobs:
  coverage:
    runs-on: ${{ matrix.os }}
    continue-on-error: true
    env:
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      COVERAGE_REPORT_DIR: /home/catkin_ws/build/${{ github.event.repository.name }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        ros_distro: [melodic]
        compiler: [g++]
    steps:
      - uses: actions/checkout@v3
      - run: mkdir ${{ github.workspace }}/coverage
      - uses: codecov/codecov-action@v3
        with:
          flags: ${{ runner.os }}-${{ matrix.ros_distro }}
          name: ${{ matrix.ros_distro }}-coverage
          token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          files: ./shared/coverage.xml
          verbose: true
      - uses: actions/cache@v3
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ matrix.ros_distro }}
      - uses: ./.github/action/build_docker
        with:
          ros_distro: ${{ matrix.ros_distro }}
          compiler: ${{ matrix.compiler }}
      - name: Build and Run coverage
        uses: addnab/docker-run-action@v3
        with:
          image: ros-ci:latest
          shell: bash
          options: -v ${{ github.workspace }}/coverage:${{ env.COVERAGE_REPORT_DIR }} -v ${{ github.workspace }}:/home/catkin_ws/src/${{ github.event.repository.name }}
          run: |
            . /opt/ros/${{ matrix.ros_distro }}/setup.bash
            cd /home/catkin_ws/src/${{ github.event.repository.name }}
            catkin build --this -v -DCMAKE_BUILD_TYPE=Coverage -DCOVERAGE_REPORT_NAME=coverage.xml
            catkin test --this -v